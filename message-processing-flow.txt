                                    Message Processing & Real-time Streaming Flow

┌─────────────┐                                                                                    ┌─────────────────┐
│   Client    │                                                                                    │  Message Queue  │
│  (Frontend) │                                                                                    │ (RabbitMQ/Kafka)│
└──────┬──────┘                                                                                    └────────┬────────┘
       │                                                                                                    │
       │  1. Send Message                                                                                   │
       │  POST /messages                                                                                    │
       │  {conversationId, content, type}                                                                   │
       ├────────────────────────────────────────────┐                                                      │
       │                                            │                                                      │
       │                                            ▼                                                      │
       │                                   ┌─────────────────┐                                             │
       │                                   │  API Gateway    │                                             │
       │                                   │  (Rate Limit)   │                                             │
       │                                   └────────┬────────┘                                             │
       │                                            │                                                      │
       │                                            ▼                                                      │
       │                                   ┌─────────────────┐                                             │
       │                                   │ Message Service │                                             │
       │                                   └────────┬────────┘                                             │
       │                                            │                                                      │
       │                                   ┌────────┴────────┐                                             │
       │                                   │ Validate Input  │                                             │
       │                                   │ • Check user    │                                             │
       │                                   │ • Check convo   │                                             │
       │                                   │ • Sanitize      │                                             │
       │                                   └────────┬────────┘                                             │
       │                                            │                                                      │
       │                                            ▼                                                      │
       │                                   ┌─────────────────┐                                             │
       │                                   │   PostgreSQL    │                                             │
       │                                   │                 │                                             │
       │                                   │ Save message    │                                             │
       │                                   │ with status     │                                             │
       │                                   │ 'pending'       │                                             │
       │                                   └────────┬────────┘                                             │
       │                                            │                                                      │
       │  2. Immediate Response                     │                                                      │
       │  {messageId, status: 'sent'}               │                                                      │
       │◄───────────────────────────────────────────┤                                                      │
       │                                            │                                                      │
       │                                            │  3. Publish to Queue                                 │
       │                                            ├─────────────────────────────────────────────────────►│
       │                                            │  Topic: message.created                               │
       │                                            │  {messageId, conversationId, senderId}               │
       │                                            │                                                      │
       │                                            │                                                      │
       │                                            │                              ┌───────────────────────┼────────┐
       │                                            │                              │  Multiple Consumers   │        │
       │                                            │                              │  Process in Parallel  │        │
       │                                            │                              └───────────────────────┼────────┘
       │                                            │                                                      │
       │                                            │                                                      ▼
       │                                            │                                         ┌─────────────────────┐
       │                                            │                                         │ Background Workers  │
       │                                            │                                         ├─────────────────────┤
       │                                            │                                         │ • Notification      │
       │                                            │                                         │   Worker           │
       │                                            │                                         │ • Analytics        │
       │                                            │                                         │   Worker           │
       │                                            │                                         │ • Media Processor  │
       │                                            │                                         │ • Search Indexer   │
       │                                            │                                         └──────────┬──────────┘
       │                                            │                                                    │
       │                                            │◄───────────────────────────────────────────────────┘
       │                                            │  4. Process Complete Events
       │                                            │
       │                                            ▼
       │                                   ┌─────────────────┐
       │                                   │ Stream Service  │
       │                                   │  (WebSocket)    │
       │                                   └────────┬────────┘
       │                                            │
       │                                   ┌────────┴────────┐
       │                                   │ Find active     │
       │                                   │ connections for │
       │                                   │ conversation   │
       │                                   │ participants   │
       │                                   └────────┬────────┘
       │                                            │
       │  5. Real-time Update                       │
       │  WebSocket: new_message event              │
       │◄───────────────────────────────────────────┤
       │                                            │


                                        WebSocket Connection Management

┌─────────────┐                          ┌─────────────────┐                          ┌─────────────────┐
│   Client    │                          │ WebSocket Server│                          │   Redis Pub/Sub │
└──────┬──────┘                          └────────┬────────┘                          └────────┬────────┘
       │                                          │                                             │
       │  1. Connect WebSocket                    │                                             │
       │  ws://api.example.com/ws?token=xxx       │                                             │
       ├─────────────────────────────────────────►│                                             │
       │                                          │                                             │
       │                                 ┌────────┴────────┐                                    │
       │                                 │ Verify JWT      │                                    │
       │                                 │ Extract userId  │                                    │
       │                                 └────────┬────────┘                                    │
       │                                          │                                             │
       │                                          │  2. Register Connection                     │
       │                                          ├────────────────────────────────────────────►│
       │                                          │  user:{userId}:connected                    │
       │                                          │  connection:{connectionId}                  │
       │                                          │                                             │
       │                                          │  3. Subscribe to User Channels              │
       │                                          ├────────────────────────────────────────────►│
       │                                          │  • user:{userId}:messages                   │
       │                                          │  • user:{userId}:notifications              │
       │                                          │  • conversation:{id}:events                 │
       │                                          │                                             │
       │  4. Connection Established               │                                             │
       │◄─────────────────────────────────────────┤                                             │
       │                                          │                                             │
       │  5. Join Conversation                    │                                             │
       │  {type: "join_conversation", id: xxx}   │                                             │
       ├─────────────────────────────────────────►│                                             │
       │                                          │                                             │
       │                                          │  6. Subscribe to Conversation               │
       │                                          ├────────────────────────────────────────────►│
       │                                          │  conversation:{id}:messages                 │
       │                                          │                                             │
       │                                          │                           7. Broadcast Event │
       │                                          │◄─────────────────────────────────────────────┤
       │                                          │                           from Redis Pub/Sub │
       │                                          │                                             │
       │  8. Forward Event to Client              │                                             │
       │◄─────────────────────────────────────────┤                                             │
       │                                          │                                             │


                                    Message Status & Delivery Tracking

┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           Message Lifecycle                                                │
├───────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                           │
│  1. PENDING     - Message saved to database but not yet processed                                        │
│  2. SENT        - Message processed and ready for delivery                                               │
│  3. DELIVERED   - Message delivered to at least one recipient device                                     │
│  4. READ        - Message read by recipient                                                              │
│                                                                                                           │
│  Status Updates Flow:                                                                                    │
│  ────────────────────                                                                                    │
│                                                                                                           │
│  Client A (Sender)              Server                        Client B (Recipient)                       │
│       │                           │                                  │                                    │
│       │  Send Message             │                                  │                                    │
│       ├──────────────────────────►│                                  │                                    │
│       │                           │                                  │                                    │
│       │  Status: SENT             │  Store & Process                │                                    │
│       │◄──────────────────────────┤                                  │                                    │
│       │                           │                                  │                                    │
│       │                           │  Push to Client B                │                                    │
│       │                           ├─────────────────────────────────►│                                    │
│       │                           │                                  │                                    │
│       │                           │  ACK: Delivered                  │                                    │
│       │                           │◄─────────────────────────────────┤                                    │
│       │                           │                                  │                                    │
│       │  Status: DELIVERED        │                                  │                                    │
│       │◄──────────────────────────┤                                  │                                    │
│       │                           │                                  │                                    │
│       │                           │                                  │  User Opens Message               │
│       │                           │                                  ├──────────┐                        │
│       │                           │                                  │          │                        │
│       │                           │  Message Read Event              │◄─────────┘                        │
│       │                           │◄─────────────────────────────────┤                                    │
│       │                           │                                  │                                    │
│       │  Status: READ             │                                  │                                    │
│       │◄──────────────────────────┤                                  │                                    │
│       │                           │                                  │                                    │
│                                                                                                           │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────┘


                                        Typing Indicators Flow

┌─────────────┐                          ┌─────────────────┐                          ┌─────────────────┐
│  Client A   │                          │     Server      │                          │   Client B      │
└──────┬──────┘                          └────────┬────────┘                          └────────┬────────┘
       │                                          │                                             │
       │  User starts typing                      │                                             │
       ├──────┐                                   │                                             │
       │      │                                   │                                             │
       │◄─────┘                                   │                                             │
       │                                          │                                             │
       │  Send typing indicator                   │                                             │
       │  {type: "typing", isTyping: true}        │                                             │
       ├─────────────────────────────────────────►│                                             │
       │                                          │                                             │
       │                                 ┌────────┴────────┐                                    │
       │                                 │ Throttle events │                                    │
       │                                 │ (1 per 3 sec)   │                                    │
       │                                 └────────┬────────┘                                    │
       │                                          │                                             │
       │                                          │  Broadcast to conversation members          │
       │                                          ├────────────────────────────────────────────►│
       │                                          │  {userId: A, isTyping: true}                │
       │                                          │                                             │
       │                                          │                                             │  Show "A is typing..."
       │                                          │                                             ├──────────┐
       │                                          │                                             │          │
       │                                          │                                             │◄─────────┘
       │                                          │                                             │
       │  User stops typing (3s timeout)          │                                             │
       ├──────┐                                   │                                             │
       │      │                                   │                                             │
       │◄─────┘                                   │                                             │
       │                                          │                                             │
       │  Send stop typing                        │                                             │
       │  {type: "typing", isTyping: false}       │                                             │
       ├─────────────────────────────────────────►│                                             │
       │                                          │                                             │
       │                                          │  Broadcast stop typing                      │
       │                                          ├────────────────────────────────────────────►│
       │                                          │  {userId: A, isTyping: false}               │
       │                                          │                                             │
       │                                          │                                             │  Hide indicator
       │                                          │                                             ├──────────┐
       │                                          │                                             │          │
       │                                          │                                             │◄─────────┘


                                    Scalability & Load Balancing

┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      Horizontal Scaling Architecture                                       │
├───────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                           │
│                                         Load Balancer (HAProxy/NGINX)                                     │
│                                                    │                                                      │
│                          ┌─────────────────────────┼─────────────────────────┐                           │
│                          │                         │                         │                           │
│                    WebSocket Server 1        WebSocket Server 2        WebSocket Server N                │
│                          │                         │                         │                           │
│                          └─────────────────────────┴─────────────────────────┘                           │
│                                                    │                                                      │
│                                              Redis Cluster                                                │
│                                          (Pub/Sub + Sessions)                                             │
│                                                    │                                                      │
│                          ┌─────────────────────────┴─────────────────────────┐                           │
│                          │                                                   │                           │
│                    Message Queue                                      Database Cluster                    │
│                 (Kafka/RabbitMQ Cluster)                            (PostgreSQL + Read Replicas)         │
│                          │                                                   │                           │
│                          └───────────────────────────────────────────────────┘                           │
│                                                                                                           │
│  Session Affinity:                                                                                       │
│  • Sticky sessions for WebSocket connections                                                             │
│  • Connection state stored in Redis                                                                      │
│  • Graceful reconnection handling                                                                        │
│                                                                                                           │
│  Message Ordering:                                                                                       │
│  • Partition messages by conversation ID                                                                  │
│  • Ensure FIFO delivery within conversations                                                             │
│  • Use message timestamps for client-side ordering                                                       │
│                                                                                                           │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────┘